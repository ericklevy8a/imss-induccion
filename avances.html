<!doctype html>
<html>

<head>

    <meta charset="UTF-8">
    <title>IMSS - Inducción al área y al puesto - Avances</title>
    <link rel="shortcut icon" type="image/x-icon" href="ico/imss.ico" />
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>

</head>

<body>

    <div class="container">

        <header></header>

        <nav>
            <ul>
                <li><a href="index.html">Inicio</a></li>
                <li><a href="guias.html">Guías</a></li>
                <li><a href="avances.html" class="active">Avances</a></li>
                <li><a href="material.html">Material</a></li>
                <li><a href="contacto.html">Contacto</a></li>
            </ul>
        </nav>

        <main>

            <h1>Programa de inducción al área y al puesto</h1>

            <article>

                <h2>Avances</h2>
                <p>Información actualizada al <span id="fecha">16 de octubre de 2022</span>.</p>

            </article>

            <article class="sidenote">

                <h2>Gráficas</h2>
                <hr>

                <div class="flex-column">

                    <div class="chart" id="hosp-chart"></div>

                    <hr>

                    <div class="chart" id="umfs-chart"></div>

                    <hr>

                    <div class="chart" id="subs-chart"></div>

                </div>

            </article>

            <article class="sidenote">

                <h2>Reportes</h2>

                <hr>

                <p><strong>Guías Pendientes por Adscripción</strong>
                    <br>Listado de guias de inducciones que áun están pendientes de afectuarse o que aún no se han
                    registrado en el sistema SIAP.
                </p>
                <select name="adscripcion" id="adscripcion">
                </select>
                <button id="buscar" class="download">Buscar</button>
                <div id="respuesta"></div>
                <div id="guias"></div>

            </article>


        </main>

        <footer>
            <p>Zaragoza No. 62, Col. Centro, C.P. 28000, Colima, Col. Tel. 312 312 6959</p>
        </footer>

    </div>

    <!-- Codigo para manejar la busqueda y despliegue de guias prellenadas -->
    <script>

        //
        // SCRIPT PARA LA GENERACION DE GRAFICAS, TABLAS, LISTADOS Y GUIAS DE INDUCCION PRE-LLENADAS
        //

        const baseUrl = ""; //"https://imss-induccion.000webhostapp.com/";

        // Referencias a objetos del DOM
        const selAdscripcion = document.getElementById('adscripcion');
        const btnBuscar = document.getElementById('buscar');
        const divRespuesta = document.getElementById('respuesta');
        const divGuias = document.getElementById('guias');
        const spanFecha = document.getElementById('fecha');

        const divHospChart = document.getElementById('hosp-chart');
        const divUMFsChart = document.getElementById('umfs-chart');
        const divSubsChart = document.getElementById('subs-chart');

        // Manejador del cambio de matrícula
        selAdscripcion.onchange = function () {
            // Habilitar boton de buscar
            btnBuscar.removeAttribute('disabled');
            // Eliminar mensajes y tabla
            divRespuesta.innerHTML = '';
            divGuias.innerHTML = '';
        }

        // Manejador del click de buscar
        btnBuscar.onclick = function () {
            // Deshabilitar boton de buscar
            btnBuscar.setAttribute('disabled', 'disabled');
            // Validar valor de matrícula
            const adscripcion = selAdscripcion.value;
            const valid = adscripcion != '0';
            if (valid) {
                // Buscar guias
                fetchGuias(adscripcion);
            } else {
                // Desplegar error
                showMsgBar(divRespuesta, 'Se debe seleccionar una adscripción válida!', 'warn');
            }
        }

        // Desplegar barra con mensaje
        function showMsgBar(container, msg, type = 'info') {
            let html = '<span class="msg-bar msg-' + type + '">';
            html += msg;
            html += '</span>';
            container.innerHTML = html;
        }

        // Obtener la fecha
        function fetchFecha() {
            const url = baseUrl + 'get_avances.php?tipo=f';
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    const fecha = new Date(data[0]['Fecha']).toLocaleDateString('es-mx', { "dateStyle": "full" });
                    spanFecha.innerHTML = fecha;
                })
                .catch(err => {
                    showMsgBar(spanFecha, 'Ocurrió un error desconocido!', 'error');
                    throw err;
                });
        }

        // Buscar datos de Hospitales
        function fetchHosp(container, dispFunct) {
            const url = baseUrl + 'get_avances.php?tipo=h';
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data.length === 0) {
                        showMsgBar(container, 'No se encontraron datos!', 'info');
                        return;
                    }
                    dispFunct(container, data);
                })
                .catch(err => {
                    showMsgBar(container, 'Ocurrió un error desconocido!', 'error');
                    throw err;
                });
        }

        // Buscar datos de UMF's
        function fetchUMFs(container, dispFunct) {
            const url = baseUrl + 'get_avances.php?tipo=u';
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data.length === 0) {
                        showMsgBar(container, 'No se encontraron datos!', 'info');
                        return;
                    }
                    dispFunct(container, data);
                })
                .catch(err => {
                    showMsgBar(container, 'Ocurrió un error desconocido!', 'error');
                    throw err;
                });
        }

        // Buscar datos de Subdelegaciones
        function fetchSubs(container, dispFunct) {
            const url = baseUrl + 'get_avances.php?tipo=s';
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data.length === 0) {
                        showMsgBar(container, 'No se encontraron datos!', 'info');
                        return;
                    }
                    dispFunct(container, data);
                })
                .catch(err => {
                    showMsgBar(container, 'Ocurrió un error desconocido!', 'error');
                    throw err;
                });
        }

        // Desplegar tabla de hospitales
        function showHospTable(container, data) {
            let html = '<table class="avances">';
            html += '<tr>';
            html += '<th>Adscripción</th>';
            html += '<th>Guías Asignadas</th>';
            html += '<th>Inducciones Realizadas</th>';
            html += '</tr>';
            for (let r = 0; r < data.length; r++) {
                html += '<tr>';
                html += `<td>${data[r]['Adscripción']}</td>`;
                html += `<td style="text-align: right">${data[r]['Asignadas']}</td>`;
                html += `<td style="text-align: right">${data[r]['Realizadas']}</td>`;
                html += '</tr>';
            }
            html += '</table>';
            container.innerHTML = html;
        }

        // Desplegar tabla de UMFs
        function showUMFsTable(container, data) {
            let html = '<table class="avances">';
            html += '<tr>';
            html += '<th>Adscripción</th>';
            html += '<th>Guías Asignadas</th>';
            html += '<th>Inducciones Realizadas</th>';
            html += '</tr>';
            for (let r = 0; r < data.length; r++) {
                html += '<tr>';
                html += `<td>${data[r]['Adscripción']}</td>`;
                html += `<td style="text-align: right">${data[r]['Asignadas']}</td>`;
                html += `<td style="text-align: right">${data[r]['Realizadas']}</td>`;
                html += '</tr>';
            }
            html += '</table>';
            container.innerHTML = html;
        }

        // Desplegar tabla de Subdelegaciones
        function showSubsTable(container, data) {
            let html = '<table class="avances">';
            html += '<tr>';
            html += '<th>Adscripción</th>';
            html += '<th>Guías Asignadas</th>';
            html += '<th>Inducciones Realizadas</th>';
            html += '</tr>';
            for (let r = 0; r < data.length; r++) {
                html += '<tr>';
                html += `<td>${data[r]['Adscripción']}</td>`;
                html += `<td style="text-align: right">${data[r]['Asignadas']}</td>`;
                html += `<td style="text-align: right">${data[r]['Realizadas']}</td>`;
                html += '</tr>';
            }
            html += '</table>';
            container.innerHTML = html;
        }

        // LISTA DE ADSCRIPCIONES

        // Buscar adscripciones para llenar la lista de selección
        function fetchAdscripciones() {
            const url = baseUrl + 'get_adscripciones.php';
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data.length === 0) {
                        showMsgBar(divRespuesta, 'No se encontraron adscripciones con guias pendientes!', 'info');
                        return;
                    }
                    populateOptions(data);
                })
                .catch(err => {
                    showMsgBar(divRespuesta, 'Ocurrió un error desconocido!', 'error');
                    throw err;
                });
        }

        // Llenar lista de adscripciones
        function populateOptions(data) {
            html = '<option value="0">Seleccionar la adscripción a reportar</option>';
            for (let r = 0; r < data.length; r++) {
                html += `<option value="${data[r]['Adscripción']}">`;
                html += `${data[r]['Guías']} - ${data[r]['Adscripción']}`;
                html += '</option>';
            }
            selAdscripcion.innerHTML = html;
        }

        // TABLA DE GUIAS DE INDUCCION PENDIENTES POR ADSCRIPCION

        // Buscar guias de induccion para una adscripción dada
        function fetchGuias(adscripcion) {
            const url = baseUrl + 'get_adscripciones.php?adscripcion=' + encodeURI(adscripcion);
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data.length === 0) {
                        showMsgBar(divRespuesta, 'No se encontraron guías de inducciones para esa adscripción!', 'info');
                        return;
                    }
                    showTable(data);
                })
                .catch(err => {
                    showMsgBar(divRespuesta, 'Ocurrió un error desconocido!', 'error');
                    throw err;
                });
        }

        // Desplegar tabla de inducciones
        function showTable(data) {
            let html = '<span class="msg-bar msg-info">';
            html += 'Se han desplegado las guías de inducción pendientes para esta adscripción:';
            html += '</span>';
            divRespuesta.innerHTML = html;
            html = '<table class="inducciones">';
            html += '<tr>';
            html += '<th>Fecha</th>';
            html += '<th>Nombre</th>';
            html += '<th>Categoría</th>';
            html += '<th>Acciones</th>';
            html += '</tr>';
            for (let r = 0; r < data.length; r++) {
                const url = makeURL(data[r]);
                html += '<tr>';
                html += `<td>${data[r]['Quincena']}</td>`;
                html += `<td>${data[r]['Nombre']}</td>`;
                html += `<td>${data[r]['Categoría']}</td>`;
                html += `<td><a class="download ver" href="${url}" target="_blank">Ver</a></td>`;
                html += '</tr>';
            }
            html += '</table>';
            divGuias.innerHTML = html;
        }

        // Formar enlaces al generador de PDF con los datos de la guía
        function makeURL(row) {
            let url = baseUrl + 'getpdf.php';
            url += '?ADSCRIPCION=' + encodeURI(row['Adscripción']);
            url += '&NOMBRE_UNIDAD=' + encodeURI(row['Adscripción']);
            url += '&CATEGORIA=' + encodeURI(row['Categoría']);
            url += '&MATRICULA=' + encodeURI(row['Matrícula']);
            url += '&NOMBRE_TRABAJADOR=' + encodeURI(row['Nombre']);
            url += '&FECHA_INGRESO=' + encodeURI(row['Quincena']);
            url += '&TIPO_COMPUESTO=' + encodeURI(row['Tipo Compuesto']);
            return url;
        }

        // GRAFICOS

        function showHospChart(container, data) {
            const pointsS1 = data.map((item, i) => new Object({ x: i + 1, y: parseInt(item["Asignadas"]), label: item["Adscripción"] }));
            const pointsS2 = data.map((item, i) => new Object({ x: i + 1, y: parseInt(item["Realizadas"]), label: item["Adscripción"] }));
            var chart = new CanvasJS.Chart(container.id, {
                animationEnabled: true,
                backgroundColor: "#fff0",
                title: {
                    text: "HOSPITALES",
                    fontFamily: "Calibri",
                    fontWeight: "bolder"
                },
                data: [
                    {
                        type: "bar",
                        showInLegend: true,
                        name: "Realizadas",
                        color: "#b9cd96",
                        dataPoints: pointsS2
                    },
                    {
                        type: "bar",
                        showInLegend: true,
                        name: "Asignadas",
                        color: "#89a54e",
                        dataPoints: pointsS1
                    },
                ]
            });
            chart.render();
        }

        function showUMFsChart(container, data) {
            const pointsS1 = data.map((item, i) => new Object({ x: i + 1, y: parseInt(item["Asignadas"]), label: item["Adscripción"] }));
            const pointsS2 = data.map((item, i) => new Object({ x: i + 1, y: parseInt(item["Realizadas"]), label: item["Adscripción"] }));
            var chart = new CanvasJS.Chart(container.id, {
                animationEnabled: true,
                backgroundColor: "#fff0",
                title: {
                    text: "UMFs",
                    fontFamily: "Calibri",
                    fontWeight: "bolder"
                },
                data: [
                    {
                        type: "column",
                        showInLegend: true,
                        name: "Realizadas",
                        color: "#b9cd96",
                        dataPoints: pointsS2
                    },
                    {
                        type: "column",
                        showInLegend: true,
                        name: "Asignadas",
                        color: "#89a54e",
                        dataPoints: pointsS1
                    },
                ]
            });
            chart.render();
        }

        function showSubsChart(container, data) {
            const pointsS1 = data.map((item, i) => new Object({ x: i + 1, y: parseInt(item["Asignadas"]), label: item["Adscripción"] }));
            const pointsS2 = data.map((item, i) => new Object({ x: i + 1, y: parseInt(item["Realizadas"]), label: item["Adscripción"] }));
            var chart = new CanvasJS.Chart(container.id, {
                animationEnabled: true,
                backgroundColor: "#fff0",
                title: {
                    text: "SUBDELEGACIONES",
                    fontFamily: "Calibri",
                    fontWeight: "bolder"
                },
                data: [
                    {
                        type: "bar",
                        showInLegend: true,
                        name: "Realizadas",
                        color: "#b9cd96",
                        dataPoints: pointsS2
                    },
                    {
                        type: "bar",
                        showInLegend: true,
                        name: "Asignadas",
                        color: "#89a54e",
                        dataPoints: pointsS1
                    },
                ]
            });
            chart.render();
        }

        // INICIALIZACION DE LA PAGINA

        // Inicializae la fecha de actualización de la base de datos
        fetchFecha();

        // Generar graficas
        fetchHosp(divHospChart, showHospChart);
        fetchUMFs(divUMFsChart, showUMFsChart);
        fetchSubs(divSubsChart, showSubsChart);

        // Inicializar el control para la selección de adscripciones tras cargar la pagina
        fetchAdscripciones();

    </script>

</body>

</html>